name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Lint & Typecheck
  # ============================================================================
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint SDK
        run: pnpm --filter @xalabaas/sdk lint

      - name: Typecheck SDK
        run: pnpm --filter @xalabaas/sdk typecheck

  # ============================================================================
  # SDK Unit Tests
  # ============================================================================
  test-sdk:
    name: SDK Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run SDK tests
        run: pnpm --filter @xalabaas/sdk test

  # ============================================================================
  # Convex Tests
  # ============================================================================
  test-convex:
    name: Convex Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Convex tests
        run: pnpm test:convex

  # ============================================================================
  # E2E Journey Tests
  # Builds the web app, serves via vite preview, runs Playwright specs.
  # ============================================================================
  test-e2e:
    name: E2E Journey Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build web app for E2E
        run: pnpm --filter @xalabaas/web build
        env:
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E tests
        run: pnpm exec playwright test
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: playwright-results.xml
          retention-days: 14

  # ============================================================================
  # Build
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test-sdk]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build packages
        run: pnpm sdk:build

  # ============================================================================
  # Verification Report
  # ============================================================================
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test-sdk, test-convex, test-e2e]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Generate verification report
        run: |
          echo "# XalaBaaS Verification Report" > verification_report.md
          echo "" >> verification_report.md
          echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> verification_report.md
          echo "" >> verification_report.md
          echo "## Job Results" >> verification_report.md
          echo "" >> verification_report.md
          echo "| Job | Status |" >> verification_report.md
          echo "|-----|--------|" >> verification_report.md
          echo "| SDK Tests | ${{ needs.test-sdk.result }} |" >> verification_report.md
          echo "| Convex Tests | ${{ needs.test-convex.result }} |" >> verification_report.md
          echo "| E2E Tests | ${{ needs.test-e2e.result }} |" >> verification_report.md

      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: verification_report.md
          retention-days: 30

  # ============================================================================
  # Deploy Frontend Apps to Hostinger (on main only)
  # Requires secrets: HOSTINGER_SSH_KEY, HOSTINGER_HOST, HOSTINGER_USER
  # ============================================================================
  deploy-hostinger:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: [build, test-report]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.test-report.result == 'success'
    env:
      # Domain Configuration
      DOMAIN_BASE: 'digilist.no'
      WEB_SUBDOMAIN: 'web'
      BACKOFFICE_SUBDOMAIN: 'backoffice'
      MINSIDE_SUBDOMAIN: 'minside-test'
      # Convex URLs for production builds
      VITE_CONVEX_URL: 'https://convex-api.digilist.no'
      CONVEX_SITE_URL: 'https://convex.digilist.no'
    steps:
      - name: Check for SSH key
        id: check-ssh
        run: |
          if [ -z "${{ secrets.HOSTINGER_SSH_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::HOSTINGER_SSH_KEY secret not set, skipping Hostinger deployment"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.check-ssh.outputs.skip != 'true'

      - name: Setup pnpm
        if: steps.check-ssh.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: steps.check-ssh.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@xala-technologies'

      - name: Install dependencies
        if: steps.check-ssh.outputs.skip != 'true'
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup SSH with password
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOSTINGER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Fix symlinks and copy assets
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          # Replace symlinks with actual file copies for deployment
          for app in web backoffice minside; do
            for link in apps/$app/public/*; do
              if [ -L "$link" ]; then
                TARGET=$(readlink -f "$link" 2>/dev/null || true)
                if [ -n "$TARGET" ] && [ -e "$TARGET" ]; then
                  echo "Copying symlink target: $link -> $TARGET"
                  rm "$link"
                  cp -r "$TARGET" "$link"
                elif [ ! -e "$link" ]; then
                  echo "Fixing broken symlink: $link"
                  rm "$link"
                  mkdir -p "$link"
                fi
              fi
            done
          done

          # Ensure seed-images are copied to web app
          if [ -d "public/seed-images" ]; then
            echo "Copying seed-images to web app..."
            rm -rf "apps/web/public/seed-images" 2>/dev/null || true
            cp -r "public/seed-images" "apps/web/public/seed-images"
          fi

      - name: Ensure theme files
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          for app in web backoffice minside; do
            THEME_DIR="apps/$app/public/themes"
            rm -rf "$THEME_DIR" 2>/dev/null || true
            mkdir -p "$THEME_DIR"
            if [ -f "packages/ds-themes/generated/digilist.css" ]; then
              cp "packages/ds-themes/generated/digilist.css" "$THEME_DIR/" || true
            fi
            if [ -f "packages/ds-themes/themes/digilist-extensions.css" ]; then
              cp "packages/ds-themes/themes/digilist-extensions.css" "$THEME_DIR/" || true
            fi
          done

      - name: Create production env files
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          for app in web backoffice minside; do
            cat > "apps/$app/.env.production" << EOF
          VITE_CONVEX_URL=${{ env.VITE_CONVEX_URL }}
          CONVEX_SITE_URL=${{ env.CONVEX_SITE_URL }}
          EOF
          done

      - name: Build all apps
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          pnpm --filter web build
          pnpm --filter backoffice build
          pnpm --filter minside build

      - name: Deploy web app
        if: steps.check-ssh.outputs.skip != 'true'
        env:
          SSHPASS: ${{ secrets.HOSTINGER_SSH_PASSWORD }}
        run: |
          REMOTE_PATH="/home/${{ secrets.HOSTINGER_USER }}/domains/${{ env.WEB_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}/public_html"
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "mkdir -p $REMOTE_PATH"
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" apps/web/dist/ ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:$REMOTE_PATH/
          echo "âœ… Deployed to https://${{ env.WEB_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}"

      - name: Deploy backoffice app
        if: steps.check-ssh.outputs.skip != 'true'
        env:
          SSHPASS: ${{ secrets.HOSTINGER_SSH_PASSWORD }}
        run: |
          REMOTE_PATH="/home/${{ secrets.HOSTINGER_USER }}/domains/${{ env.BACKOFFICE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}/public_html"
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "mkdir -p $REMOTE_PATH"
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" apps/backoffice/dist/ ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:$REMOTE_PATH/
          echo "âœ… Deployed to https://${{ env.BACKOFFICE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}"

      - name: Deploy minside app
        if: steps.check-ssh.outputs.skip != 'true'
        env:
          SSHPASS: ${{ secrets.HOSTINGER_SSH_PASSWORD }}
        run: |
          REMOTE_PATH="/home/${{ secrets.HOSTINGER_USER }}/domains/${{ env.MINSIDE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}/public_html"
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "mkdir -p $REMOTE_PATH"
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" apps/minside/dist/ ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:$REMOTE_PATH/
          echo "âœ… Deployed to https://${{ env.MINSIDE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }}"

      - name: Fix file permissions
        if: steps.check-ssh.outputs.skip != 'true'
        env:
          SSHPASS: ${{ secrets.HOSTINGER_SSH_PASSWORD }}
        run: |
          for subdomain in ${{ env.WEB_SUBDOMAIN }} ${{ env.BACKOFFICE_SUBDOMAIN }} ${{ env.MINSIDE_SUBDOMAIN }}; do
            REMOTE_PATH="/home/${{ secrets.HOSTINGER_USER }}/domains/${subdomain}.${{ env.DOMAIN_BASE }}/public_html"
            sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
              "find $REMOTE_PATH -type f -exec chmod 644 {} \; && find $REMOTE_PATH -type d -exec chmod 755 {} \;" || true
          done

      - name: Deployment summary
        if: steps.check-ssh.outputs.skip != 'true'
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Web | https://${{ env.WEB_SUBDOMAIN }}.${{ env.DOMAIN_BASE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backoffice | https://${{ env.BACKOFFICE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minside | https://${{ env.MINSIDE_SUBDOMAIN }}.${{ env.DOMAIN_BASE }} |" >> $GITHUB_STEP_SUMMARY

